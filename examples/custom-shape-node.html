<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Custom Shape Node Example</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
    }
    
    #container {
      border: 1px solid #ccc;
      width: 800px;
      height: 600px;
    }
  </style>
</head>
<body>
  <h1>Custom Shape Node Example</h1>
  <div id="container"></div>

  <script src="../node_modules/@antv/g-lite/dist/index.umd.min.js"></script>
  <script src="../node_modules/@antv/g-svg/dist/index.umd.min.js"></script>
  <script src="../node_modules/@antv/g-plugin-annotation/dist/index.umd.min.js"></script>
  <script src="../node_modules/@antv/g-plugin-dragndrop/dist/index.umd.min.js"></script>
  <script src="../packages/ge-core/dist/index.umd.min.js"></script>
  <script>
    const { Canvas, Rect, Circle, Line, Polyline, Annotation, Dragndrop, Shape, Polygon, Ellipse } = window.G;
    const { Graph, Node, Edge, ConnectionPlugin } = window.GE;

    const renderer = new window.G.SVG.Renderer()
    renderer.registerPlugin(new Annotation.Plugin());
    renderer.registerPlugin(new Dragndrop.Plugin());
    
    // Create a graph
    const graph = new Graph({
      container: document.getElementById('container'),
      width: 800,
      height: 600,
      renderer,
    });

    // Prefer graph.document.customElements so resolveCtor prefers the graph-scoped registry
    graph.customElements.define('custom-circle', Circle);
    // Register a port-specific shape name as well (can reuse Circle or a custom ctor)
    graph.customElements.define('custom-port', Circle);

    // Wait for canvas to be ready before adding elements
    graph.ready.then(() => {
      console.log('Graph ready, creating nodes and edges...');

      const conn = new ConnectionPlugin({ defaultEdgeStyle: { stroke: '#888', lineWidth: 1 } });
      graph.installPlugin(conn);
      
      // Create a circle node using registry name
      const circleNode = new Node({
        id: 'circle-node',
        x: 100,
        y: 100,
        // shape: 'custom-circle', // Use the registered name
        // shape: Shape.CIRCLE, // 'custom-circle',
        shape: Circle, // Use the Circle class directly
        style: {
          r: 40,
          fill: '#1890ff',
          stroke: '#000',
          lineWidth: 2,
          label: 'Circle Node',
          labelFill: '#fff',
          labelFontSize: 14
        }
      });

      // Create another circle node using ctor directly
      const customCircleNode = new Node({
        id: 'custom-circle-node',
        x: 200,
        y: 200,
        shape: Circle,
        style: {
          r: 30,
          fill: '#ff0000',
          stroke: '#000',
          lineWidth: 2,
          label: 'Custom Circle',
          labelFill: '#fff',
          labelFontSize: 12
        }
      });

      // Add the nodes to the graph
      graph.appendChild(circleNode);
      graph.appendChild(customCircleNode);

      // Create a rect node using default rect (no shape override)
      const rectNode = new Node({
        id: 'rect-node',
        x: 300,
        y: 100,
        style: {
          width: 100,
          height: 40,
          fill: '#fff',
          stroke: '#000',
          lineWidth: 1,
          radius: 4,
          label: 'Rect Node',
          labelFill: '#000',
          labelFontSize: 12
        }
      });

      // Add the node to the graph
      graph.appendChild(rectNode);

      // Create ports on nodes with different layouts; demonstrate registry-based port shape
      circleNode.createPort({ id: 'top', layout: 'top', style: {}, shape: 'custom-port' });
      circleNode.createPort({ id: 'right', layout: 'right', shape: 'custom-port' });
      circleNode.createPort({ id: 'bottom', layout: 'bottom', shape: 'custom-port' });
      circleNode.createPort({ id: 'left', layout: 'left', shape: 'custom-port' });

      rectNode.createPort({ id: 'top', layout: 'top', shape: 'custom-port' });
      rectNode.createPort({ id: 'bottom', layout: 'bottom', shape: 'custom-port' });
      customCircleNode.createPort({ id: 'angle-45', layout: { name: 'angle', args: { angle: 45 } }, shape: 'custom-port' });
      customCircleNode.createPort({ id: 'angle-135', layout: { name: 'angle', args: { angle: 135 } }, shape: 'custom-port' });


      // Create a line edge using node objects directly (will connect to node centers)
      const lineEdge = new Edge({
        id: 'line-edge',
        source: circleNode,  // 直接使用节点对象
        target: rectNode,    // 直接使用节点对象
        style: {
          stroke: '#000',
          lineWidth: 1
        }
      });

      graph.appendChild(lineEdge);

      // Create a polyline edge using port objects directly
      const polylineEdge = new Edge({
        id: 'polyline-edge',
        source: circleNode.getPort('right'),  // 直接使用端口对象
        target: rectNode.getPort('top'),      // 直接使用端口对象
        style: {
          stroke: '#ff0000',
          lineWidth: 2,
          lineDash: [5, 5]
        }
      });

      graph.appendChild(polylineEdge);

      // Also demonstrate a port-to-port connection between the two circles
      const portEdge = new Edge({
        id: 'port-edge',
        source: customCircleNode.getPort('angle-45'),  // 直接使用端口对象
        target: circleNode.getPort('left'),            // 直接使用端口对象
        style: {
          stroke: '#00aa00',
          lineWidth: 1
        }
      });

      graph.appendChild(portEdge);

      // Create a polygon node (complex shape) and add angle ports to test ray intersection
      const polygonNode = new Node({
        id: 'poly-node',
        x: 520,
        y: 140,
        shape: Polygon,
        style: {
          // points are local coordinates relative to the node
          points: [[-60,-30],[60,-30],[80,0],[60,30],[-60,30],[-80,0]],
          fill: '#f5a623',
          stroke: '#000',
          lineWidth: 1,
          label: 'Polygon Node',
          labelFill: '#000',
          labelFontSize: 12
        }
      });
      graph.appendChild(polygonNode);
      // Ports on polygon using angles that may hit vertices or edges
      polygonNode.createPort({ id: 'poly-angle-0', layout: { name: 'angle', args: { angle: 0 } }, shape: 'custom-port' });
      polygonNode.createPort({ id: 'poly-angle-45', layout: { name: 'angle', args: { angle: 45 } }, shape: 'custom-port' });
      polygonNode.createPort({ id: 'poly-angle-90', layout: { name: 'angle', args: { angle: 90 } }, shape: 'custom-port' });

      // Create an ellipse node and add ports including absolute coords
      const ellipseNode = new Node({
        id: 'ellipse-node',
        x: 520,
        y: 320,
        shape: Ellipse,
        style: {
          cx: 0,
          cy: 0,
          rx: 50,
          ry: 30,
          fill: '#8e44ad',
          stroke: '#000',
          lineWidth: 1,
          label: 'Ellipse Node',
          labelFill: '#fff',
          labelFontSize: 12
        }
      });
      graph.appendChild(ellipseNode);
      ellipseNode.createPort({ id: 'ellipse-top', layout: 'top', shape: 'custom-port' });
      ellipseNode.createPort({ id: 'ellipse-angle-30', layout: { name: 'angle', args: { angle: 30 } }, shape: 'custom-port' });
      ellipseNode.createPort({ id: 'ellipse-abs', layout: { name: 'absolute', args: { x: 10, y: -10 } }, shape: 'custom-port' });

      // Connect edges to exercise different port placements
      const polyEdge = new Edge({
        id: 'poly-edge',
        source: polygonNode.getPort('poly-angle-45'),
        target: ellipseNode.getPort('ellipse-angle-30'),
        style: { stroke: '#0066cc', lineWidth: 1 }
      });
      graph.appendChild(polyEdge);

      const ellipseEdge = new Edge({
        id: 'ellipse-edge',
        source: rectNode.getPort('top'),
        target: ellipseNode.getPort('ellipse-top'),
        style: { stroke: '#cc0000', lineWidth: 1 }
      });
      graph.appendChild(ellipseEdge);

      console.log('Graph with custom shape nodes, ports and edges created');
    });
   </script>
 </body>
 </html>